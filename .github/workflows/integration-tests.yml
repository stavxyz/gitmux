name: Integration Tests

on:
  # Manual trigger with option to run destructive tests
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run integration tests (creates/deletes test repos)'
        required: true
        default: 'true'
        type: boolean

  # Scheduled weekly run to catch regressions
  schedule:
    # Run every Monday at 6:00 UTC
    - cron: '0 6 * * 1'

jobs:
  integration-tests:
    name: Shell Integration Tests
    runs-on: ubuntu-latest
    # Only run if GH_TOKEN secret is configured
    if: ${{ github.event.inputs.run_tests != 'false' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify GH_TOKEN is configured
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [[ -z "${GH_TOKEN}" ]]; then
            echo "::error::GH_TOKEN secret is not configured."
            echo ""
            echo "To enable integration tests, add a GH_TOKEN secret to this repository:"
            echo "  1. Go to Settings > Secrets and variables > Actions"
            echo "  2. Click 'New repository secret'"
            echo "  3. Name: GH_TOKEN"
            echo "  4. Value: A personal access token with 'repo' and 'delete_repo' scopes"
            echo ""
            echo "See: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token"
            exit 1
          fi
          echo "GH_TOKEN is configured"

      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Run integration tests
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_HOST: github.com
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Running integration tests..."
          echo "Test repos will be created under: ${GITHUB_OWNER}"
          ./test_gitmux.sh

      - name: Cleanup test repositories (on failure)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "Cleaning up any leftover test repositories..."
          repos=$(gh repo list --limit 99 --json nameWithOwner,name --jq '.[]|select(.name|startswith("gitmux_test_")).nameWithOwner' || echo "")
          if [[ -n "$repos" ]]; then
            for r in $repos; do
              echo "Deleting leftover test repo: $r"
              gh api --method DELETE "repos/$r" || true
            done
          fi
